!!!
%html{lang: "en"}
  %head
    %meta{charset: "UTF-8"}
    %meta{name: "viewport", content: "width=device-width, initial-scale=1"}
    %title SVXReflector · Stats
    %script{src: "https://cdn.tailwindcss.com"}
    :javascript
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              ghbg: '#0d1117',
              ghcard: '#161b22',
              ghborder: '#30363d',
              ghborder2: '#21262d',
              ghtext: '#c9d1d9',
              ghmuted: '#8b949e',
              ghdim: '#6e7681',
            }
          }
        }
      }
    %link{rel: "stylesheet", href: "https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"}
    :css
      body { background: #0d1117; }

      .ws-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; vertical-align: middle; }
      .ws-connected    { background: #3fb950; }
      .ws-disconnected { background: #f85149; }
      .ws-connecting   { background: #d29922; animation: blink 1s step-start infinite; }
      @keyframes blink { 50% { opacity: .2; } }

      .stat-card          { border: 1px solid #30363d; }

      .section-label {
        font-size: .72rem; text-transform: uppercase;
        letter-spacing: .07em; color: #6e7681; font-weight: 600;
        margin-bottom: .75rem;
      }

      /* Period filter pills */
      .period-pill {
        font-size: .78rem; padding: .3rem .85rem;
        border-radius: 2em; border: 1px solid #30363d;
        color: #8b949e; background: transparent; cursor: pointer;
        text-decoration: none; transition: background .15s, color .15s, border-color .15s;
      }
      .period-pill:hover { background: #21262d; color: #c9d1d9; border-color: #6e7681; }
      .period-pill.active { background: #1f6feb; border-color: #1f6feb; color: #fff; }

      /* Ranking bars */
      .rank-bar-wrap { height: 5px; background: #21262d; border-radius: 3px; }
      .rank-bar-fill { height: 100%; border-radius: 3px; min-width: 2px; }

      /* Signal bars */
      .sig-bar-wrap { height: 5px; background: #21262d; border-radius: 3px; min-width: 60px; }
      .sig-bar-fill { height: 100%; border-radius: 3px; min-width: 2px; }

      .nodes-table th { font-size: .73rem; text-transform: uppercase; letter-spacing: .05em; color: #6e7681; border-color: #21262d; }
      .nodes-table td { font-size: .82rem; border-color: #21262d; vertical-align: middle; }
      .nodes-table tbody tr:hover { background: #161b22; }

      .tg-badge {
        font-size: .72rem; padding: .15em .55em;
        background: #21262d; border: 1px solid #30363d;
        border-radius: 2em; color: #8b949e; font-family: monospace;
      }
      .tg-badge.active { background: #1f3a5f; border-color: #1f6feb; color: #79c0ff; }

      .cls-pill {
        font-size: .7rem; padding: .15em .6em;
        background: #161b22; border: 1px solid #30363d;
        border-radius: .2em; color: #8b949e;
        text-transform: capitalize; font-family: monospace;
      }

      .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
      .dot-talking { background: #3fb950; box-shadow: 0 0 6px rgba(63,185,80,.5); }
      .dot-active  { background: #1f6feb; }
      .dot-idle    { background: #6e7681; }

      .tg-row { border-color: #21262d !important; }
      .tg-row:hover { background: #161b22 !important; }

      .cls-progress-wrap { height: 6px; background: #21262d; border-radius: 3px; overflow: hidden; }
      .cls-progress-fill { height: 100%; border-radius: 3px; }

      .event-row { font-size: .8rem; border-color: #21262d !important; }
      .event-row:hover { background: #161b22 !important; }

      .divider-label {
        font-size: .7rem; text-transform: uppercase; letter-spacing: .08em;
        color: #6e7681; font-weight: 600;
        display: flex; align-items: center; gap: .75rem;
      }
      .divider-label::before, .divider-label::after {
        content: ''; flex: 1; height: 1px; background: #21262d;
      }

      .event-type-badge {
        font-size: .67rem; padding: .1em .55em;
        border-radius: .25em; font-family: monospace; font-weight: 600;
      }
  %body.text-ghtext

    = render 'shared/navbar', active: 'stats', ws_indicator: true

    .px-3.md:px-4

      -# ── Fetch error ──────────────────────────────────────────────────────
      - if @fetch_error
        .flex.items-center.p-3.rounded-lg.mb-4{class: "bg-yellow-900/30 border border-yellow-700 text-yellow-400", role: "alert"}
          %i.bi.bi-exclamation-triangle-fill.mr-2.shrink-0
          = @fetch_error

      -# ── Stats row (same as dashboard) ──────────────────────────────────
      - stats = []
      - stats << {icon: 'bi-diagram-3',   color: 'text-gray-100',  label: 'Nodes',   val: @total}
      - stats << {icon: 'bi-wifi',        color: 'text-blue-500',  label: 'Active',  val: @active}
      - stats << {icon: 'bi-mic-fill',    color: 'text-green-500', label: 'Talking', val: @talking}
      - stats << {icon: 'bi-collection',  color: 'text-yellow-500', label: 'TGs',    val: @active_tgs.size}
      .grid.grid-cols-2.md:grid-cols-4.gap-3.mb-4
        - stats.each do |s|
          .rounded-lg.border.border-ghborder.h-full
            .text-center.py-3
              .text-4xl.font-bold{class: s[:color]}= s[:val]
              .text-gray-500.text-sm.mt-1
                %i.bi{class: s[:icon]}
                = s[:label]

      .grid.grid-cols-1.md:grid-cols-3.gap-4.mb-5

        -# Node class breakdown
        .rounded-lg.border.border-ghborder.h-full
          .p-4
            .section-label
              %i.bi.bi-pie-chart.mr-1
              Node Types
            - if @by_class.any?
              - @by_class.each do |cls, count|
                - pct     = @total > 0 ? (count.to_f / @total * 100).round : 0
                - cls_col  = { 'repeater' => 'blue', 'bridge' => 'yellow', 'simplex' => 'green' }.fetch(cls, 'gray')
                - cls_icon = { 'repeater' => 'bi-arrow-repeat', 'bridge' => 'bi-link-45deg', 'simplex' => 'bi-broadcast' }.fetch(cls, 'bi-broadcast')
                .mb-3
                  .flex.justify-between.items-center.mb-1
                    %span.text-gray-500.text-sm.capitalize
                      %i.bi.mr-1{class: "#{cls_icon} text-#{cls_col}-500"}
                      = cls
                    %span.text-gray-100.font-semibold.text-sm
                      = count
                      %span.text-gray-500.font-normal= "(#{pct}%)"
                  .cls-progress-wrap
                    .cls-progress-fill{class: "bg-#{cls_col}-500", style: "width:#{pct}%"}
            - else
              %p.text-gray-500.text-sm.mb-0 No nodes connected.

        -# Active talkgroups
        .rounded-lg.border.border-ghborder.h-full
          .p-4
            .section-label
              %i.bi.bi-collection.mr-1
              Active Talkgroups
            - if @active_tgs.any?
              .rounded.overflow-hidden
                - @active_tgs.each do |tg, callsigns|
                  .tg-row.px-2.py-2.border-b
                    .flex.items-center.justify-between
                      %span.font-bold.font-mono.text-yellow-500= "TG #{tg}"
                      .flex.flex-wrap.gap-1.justify-end
                        - callsigns.each do |cs|
                          - n = @sorted_nodes.find { |c, _| c == cs }&.last
                          %span.tg-badge{class: (n&.dig('isTalker') ? 'active' : nil)}
                            - if n&.dig('isTalker')
                              %i.bi.bi-mic-fill.mr-1.text-green-500{style: "font-size:.65rem"}
                            = cs
            - else
              %p.text-gray-500.text-sm.mb-0 No talkgroups currently active.

        -# Signal strength
        .rounded-lg.border.border-ghborder.h-full
          .p-4
            .section-label
              %i.bi.bi-reception-4.mr-1
              Signal Levels
            - if @sorted_nodes.any?
              - node_sigs = @sorted_nodes.map { |cs, n| [cs, n, (n['qth'] || []).flat_map { |q| (q['rx'] || {}).map { |p, r| [p, r] } }.map { |_, r| r['siglev'] }.compact.max] }
              - node_sigs = node_sigs.sort_by { |_, _, sig| -(sig || -999) }
              %div{style: "max-height:320px;overflow-y:auto;scrollbar-width:thin"}
                - node_sigs.each do |cs, n, best_sig|
                  - tg        = n['tg'].to_i
                  - is_talker = n['isTalker']
                  - dot_cls   = is_talker ? 'dot-talking' : (tg != 0 ? 'dot-active' : 'dot-idle')
                  - pct       = best_sig.nil? ? nil : (best_sig < 0 ? [[((best_sig + 120) / 100.0 * 100).round, 0].max, 100].min : [[best_sig.to_i, 0].max, 100].min)
                  - bar_col   = pct ? (pct > 66 ? 'green' : (pct > 33 ? 'yellow' : 'red')) : 'gray'
                  .flex.items-center.gap-2.mb-2
                    %span.status-dot{class: dot_cls}
                    %span.font-mono.text-gray-100{style: "min-width:90px;font-size:.82rem"}= cs
                    - if pct
                      .sig-bar-wrap.grow
                        .sig-bar-fill{class: "bg-#{bar_col}-500", style: "width:#{pct}%"}
                      %span.font-mono.text-gray-500{style: "font-size:.75rem;min-width:60px;text-align:right"}
                        = "#{best_sig.round}#{best_sig < 0 ? ' dBm' : '%'}"
                    - else
                      .grow
                      %span.text-gray-500{style: "font-size:.75rem"} —
            - else
              %p.text-gray-500.text-sm.mb-0 No nodes connected.

      -# ════════════════════════════════════════════════════════════════════
      -# HISTORICAL USAGE
      -# ════════════════════════════════════════════════════════════════════

      -# Period filter
      .flex.items-center.justify-between.mb-4.flex-wrap.gap-3
        .divider-label.grow{style: "max-width:160px"}
          %i.bi.bi-clock-history.mr-1
          Usage History
        .flex.items-center.gap-2
          %span.text-gray-500.text-sm.mr-1 Period:
          - [['all', 'All time'], ['day', 'Today'], ['month', 'Month'], ['year', 'Year']].each do |val, label|
            %a.period-pill{href: stats_path(period: val), class: (@period == val ? 'active' : nil)}
              = label

      -# Historical summary cards
      - hist_cards = []
      - hist_cards << {icon: 'bi-mic-fill',     color: 'text-green-500',  label: 'Transmissions',   val: @hist_talks}
      - hist_cards << {icon: 'bi-collection',   color: 'text-yellow-500', label: 'TG Sessions',     val: @hist_tg_joins}
      - hist_cards << {icon: 'bi-person-badge', color: 'text-blue-500',   label: 'Unique Nodes',    val: @hist_unique_nodes}
      - hist_cards << {icon: 'bi-diagram-3',    color: 'text-cyan-500',   label: 'Unique TGs',      val: @hist_unique_tgs}
      .grid.grid-cols-2.md:grid-cols-4.gap-3.mb-4
        - hist_cards.each do |s|
          .stat-card.rounded-lg.h-full
            .text-center.py-3
              .text-4xl.font-bold{class: s[:color]}= s[:val]
              .text-gray-500.text-sm.mt-1
                %i.bi{class: s[:icon]}
                = s[:label]

      .grid.grid-cols-1.md:grid-cols-2.gap-4.mb-4

        -# Top talkers
        .rounded-lg.border.border-ghborder.h-full
          .p-4
            .section-label
              %i.bi.bi-trophy.mr-1
              Top Talkers
            - if @top_talkers.any?
              - max_talks = @top_talkers.values.first.to_f
              - @top_talkers.each_with_index do |(cs, count), i|
                .flex.items-center.gap-2.mb-2
                  %span.text-gray-500{style: "font-size:.7rem;min-width:18px;text-align:right"}= i + 1
                  %span.font-mono.text-gray-100.shrink-0{style: "min-width:90px;font-size:.82rem"}= cs
                  .rank-bar-wrap.grow
                    .rank-bar-fill.bg-green-500{style: "width:#{(count / max_talks * 100).round}%"}
                  %span.text-gray-500.font-semibold{style: "font-size:.78rem;min-width:28px;text-align:right"}= count
            - else
              .text-center.text-gray-500.py-4.text-sm
                %i.bi.bi-mic-mute.block.text-xl.mb-2
                = "No transmissions recorded#{@period != 'all' ? ' for this period' : ''}."

        -# Top talkgroups
        .rounded-lg.border.border-ghborder.h-full
          .p-4
            .section-label
              %i.bi.bi-bar-chart.mr-1
              Top Talkgroups
            - if @top_tgs.any?
              - max_tg = @top_tgs.values.first.to_f
              - @top_tgs.each_with_index do |(tg, count), i|
                .flex.items-center.gap-2.mb-2
                  %span.text-gray-500{style: "font-size:.7rem;min-width:18px;text-align:right"}= i + 1
                  %span.font-mono.text-yellow-500.font-semibold.shrink-0{style: "min-width:52px;font-size:.82rem"}
                    = "TG #{tg}"
                  .rank-bar-wrap.grow
                    .rank-bar-fill.bg-yellow-500{style: "width:#{(count / max_tg * 100).round}%"}
                  %span.text-gray-500.font-semibold{style: "font-size:.78rem;min-width:28px;text-align:right"}= count
            - else
              .text-center.text-gray-500.py-4.text-sm
                %i.bi.bi-collection.block.text-xl.mb-2
                = "No talkgroup activity recorded#{@period != 'all' ? ' for this period' : ''}."

      -# Recent events
      .rounded-lg.border.border-ghborder.mb-4
        .p-0
          .px-3.pt-3.pb-2.section-label
            %i.bi.bi-activity.mr-1
            Recent Events
            %span.ml-2.inline-block.px-2.py-0.5.text-xs.rounded-full.bg-gray-600.text-gray-200.font-normal= @recent_events.size
          - if @recent_events.any?
            %div{style: "max-height:280px;overflow-y:auto;scrollbar-width:thin"}
              - @recent_events.each do |ev|
                - type_style = {'talking_start' => ['bg-green-600 text-white', 'bi-mic-fill'], 'talking_stop' => ['bg-gray-600 text-white', 'bi-mic-mute'], 'tg_join' => ['bg-blue-600 text-white', 'bi-collection'], 'tg_leave' => ['bg-gray-600 text-white', 'bi-collection'], 'connected' => ['bg-cyan-600 text-white', 'bi-plug-fill'], 'disconnected' => ['bg-red-600 text-white', 'bi-plug']}.fetch(ev.event_type, ['bg-gray-600 text-white', 'bi-dot'])
                .event-row.px-3.py-2.flex.items-center.gap-3.border-b
                  %span.text-gray-500.font-mono{style: "font-size:.72rem;min-width:75px"}
                    = ev.created_at.strftime('%m-%d %H:%M')
                  %span.event-type-badge{class: type_style[0]}
                    %i.bi{class: "#{type_style[1]} mr-1"}
                    = ev.event_type.tr('_', ' ')
                  %strong.font-mono.text-gray-100{style: "font-size:.82rem"}= ev.callsign
                  - if ev.tg.to_i != 0
                    %span.text-gray-500.text-sm
                      TG
                      %span.text-yellow-500.font-semibold= ev.tg
                  - if ev.node_location.present?
                    %span.text-gray-500.text-sm.ml-auto
                      %i.bi.bi-geo-alt.mr-1
                      = ev.node_location
          - else
            .text-center.text-gray-500.py-4.text-sm
              %i.bi.bi-hourglass-split.block.text-xl.mb-2
              No events recorded yet.

      -# ════════════════════════════════════════════════════════════════════
      -# FULL NODES TABLE
      -# ════════════════════════════════════════════════════════════════════

      .divider-label.mb-4
        %i.bi.bi-hdd-network.mr-1
        All Nodes
        %span.inline-block.px-2.py-0.5.text-xs.rounded-full.bg-gray-600.text-gray-200.font-normal.ml-1= @sorted_nodes.size

      .rounded-lg.border.border-ghborder.mb-5
        .p-0
          - if @sorted_nodes.any?
            .overflow-x-auto
              %table.w-full.text-left.nodes-table
                %thead
                  %tr.border-b.border-ghborder2
                    %th.py-2.pl-3 Callsign
                    %th.py-2 Status
                    %th.py-2 Type
                    %th.py-2 Location
                    %th.py-2 Talkgroup
                    %th.py-2 Monitored TGs
                    %th.py-2 Best Signal
                    %th.py-2 Software
                %tbody
                  - @sorted_nodes.each do |cs, n|
                    - tg        = n['tg'].to_i
                    - is_talker = n['isTalker']
                    - st_col    = is_talker ? 'green' : (tg != 0 ? 'blue' : 'gray')
                    - st_txt    = is_talker ? "Talking \u00B7 TG #{tg}" : (tg != 0 ? "TG #{tg}" : 'Idle')
                    - node_icon = { 'repeater' => 'bi-arrow-repeat', 'bridge' => 'bi-link-45deg', 'simplex' => 'bi-broadcast' }.fetch(n['nodeClass'].to_s, 'bi-broadcast')
                    - rx_ports  = (n['qth'] || []).flat_map { |q| (q['rx'] || {}).map { |p, r| [p, r] } }
                    - best_sig  = rx_ports.map { |_, r| r['siglev'] }.compact.max
                    - qth       = n.dig('qth', 0) || {}
                    - locator   = qth.dig('pos', 'loc')
                    - location  = [n['nodeLocation'], locator ? "(#{locator})" : nil].compact.join(' ')
                    %tr.border-b.border-ghborder2.hover:bg-ghcard
                      %td.py-2.pl-3
                        - if is_talker
                          %i.bi.bi-mic-fill.text-green-500.mr-1{style: "font-size:.75rem"}
                        %strong.font-mono.text-gray-100= cs
                      %td.py-2
                        %span.inline-block.px-2.py-0.5.text-xs.rounded.font-semibold{class: "bg-#{st_col}-600 text-white"}= st_txt
                      %td.py-2
                        %span.cls-pill
                          %i.bi.mr-1{class: node_icon}
                          = n['nodeClass'] || '—'
                      %td.py-2.text-gray-500= location.presence || '—'
                      %td.py-2
                        - if tg != 0
                          %span.font-mono.text-yellow-500.font-semibold= tg
                        - else
                          %span.text-gray-500 —
                      %td.py-2
                        .flex.flex-wrap.gap-1
                          - (n['monitoredTGs'] || []).each do |tg_num|
                            %span.tg-badge{class: (tg_num == tg && tg != 0 ? 'active' : nil)}= tg_num
                      %td.py-2
                        - if best_sig
                          - pct2 = best_sig < 0 ? [[((best_sig + 120) / 100.0 * 100).round, 0].max, 100].min : [[best_sig.to_i, 0].max, 100].min
                          - bar2 = pct2 > 66 ? 'green' : (pct2 > 33 ? 'yellow' : 'red')
                          .flex.items-center.gap-2
                            .sig-bar-wrap{style: "width:64px"}
                              .sig-bar-fill{class: "bg-#{bar2}-500", style: "width:#{pct2}%"}
                            %span.font-mono.text-gray-500{style: "font-size:.75rem"}
                              = "#{best_sig.round}#{best_sig < 0 ? ' dBm' : '%'}"
                        - else
                          %span.text-gray-500 —
                      %td.py-2.text-gray-500{style: "font-size:.75rem"}
                        = [n['sw'], n['swVer']].compact.join(' ').presence || '—'
          - else
            .text-center.text-gray-500.py-5
              %i.bi.bi-hdd-network.text-6xl.block.mb-2
              No nodes currently connected.

    :javascript
      (function () {
        'use strict';
        function setWs(state) {
          var dot   = document.getElementById('ws-dot');
          var label = document.getElementById('ws-label');
          if (dot)   dot.className   = 'ws-dot ws-' + state;
          if (label) label.textContent =
            state === 'connected'    ? 'Live'         :
            state === 'disconnected' ? 'Disconnected' : 'Connecting\u2026';
        }
        function connectWs() {
          setWs('connecting');
          var proto = location.protocol === 'https:' ? 'wss' : 'ws';
          var ws = new WebSocket(proto + '://' + location.host + '/cable');
          ws.onopen = function () {
            ws.send(JSON.stringify({ command: 'subscribe', identifier: JSON.stringify({ channel: 'UpdatesChannel' }) }));
          };
          ws.onmessage = function (ev) {
            var envelope;
            try { envelope = JSON.parse(ev.data); } catch (e) { return; }
            if (envelope.type === 'welcome') { setWs('connected'); return; }
          };
          ws.onclose = function () { setWs('disconnected'); setTimeout(connectWs, 5000); };
          ws.onerror = function () { setWs('disconnected'); };
        }
        connectWs();
      })();
